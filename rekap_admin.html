<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Rekap Musrenbang Makale</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .header-nav { background: #1a202c; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Stats Dashboard */
        .stats-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-bottom: 20px; }
        .summary-box { padding: 15px; border-radius: 8px; color: white; margin-bottom: 10px; }
        .bg-blue { background: #3182ce; }
        .bg-green { background: #38a169; }
        .opd-list { height: 160px; overflow-y: auto; font-size: 12px; }
        .opd-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; }

        /* Toolbar */
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .search-input { flex-grow: 1; min-width: 250px; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 12px; font-weight: bold; }
        
        .btn-pdf { background: #e53e3e; color: white; border: none; cursor: pointer; }
        .btn-excel { background: #38a169; color: white; border: none; cursor: pointer; }
        .btn-back { background: #4a5568; color: white; border: none; cursor: pointer; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #edf2f7; padding: 10px; text-align: left; }
        th { background: #f7fafc; }

        /* Print Style */
        .print-only { display: none; text-align: center; }
        @media print {
            @page { size: landscape; margin: 1cm; }
            .no-print { display: none !important; }
            .print-only { display: block !important; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000 !important; padding: 5px; font-size: 9px; }
            .print-footer { display: block !important; position: fixed; bottom: 0; width: 100%; text-align: left; font-style: italic; font-size: 9px; }
        }
    </style>
</head>
<body>

<div class="header-nav no-print">
    <strong>Admin Kecamatan Makale</strong>
    <span id="clock" style="font-size: 12px;"></span>
</div>

<div class="container">
    <div class="print-only">
        <h2 style="margin:0;">Aplikasi Input usulan Musrenbang Kelurahan Kec. Makale Kab. Tana Toraja - Dikembangkan oleh : Fuad Amry</h2>
    </div>

    <div class="stats-grid no-print">
        <div>
            <div class="summary-box bg-blue">
                <small>Total Anggaran Kecamatan</small>
                <div id="totalKec" style="font-size: 22px; font-weight: bold;">Rp 0</div>
            </div>
            <div class="summary-box bg-green">
                <small>Total Terfilter</small>
                <div id="totalFil" style="font-size: 22px; font-weight: bold;">Rp 0</div>
            </div>
        </div>
        <div class="card" style="margin:0">
            <h4 style="margin:0 0 10px 0;">üìä Statistik Usulan per OPD</h4>
            <div id="opdStats" class="opd-list">Memproses data...</div>
        </div>
    </div>

    <div class="card no-print">
        <div class="toolbar">
            <input type="text" id="src" onkeyup="filter()" placeholder="üîç Cari kegiatan/lokasi..." class="search-input">
            <select id="fKel" onchange="filter()"><option value="">Semua Wilayah</option></select>
            <select id="fOPD" onchange="filter()"><option value="">Semua OPD</option></select>
            <button class="btn-excel" onclick="exportEx()">üì§ Excel</button>
            <button class="btn-pdf" onclick="window.print()">üñ®Ô∏è PDF</button>
            <button class="btn-back" onclick="window.location.href='index.html'">üè† Beranda</button>
        </div>
    </div>

    <div class="card">
        <table id="mainTab">
            <thead>
                <tr>
                    <th>No</th><th>Kelurahan/Lembang</th><th>Bidang</th><th>Kegiatan</th><th>Lokasi</th><th>Volume</th><th>Anggaran</th><th>OPD Pelaksana</th><th>Keterangan</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div class="print-footer no-print" style="display:none; margin-top:10px; font-size:9px; font-style:italic;">
        * Aplikasi Input usulan Musrenbang Kelurahan Kec. Makale Kab. Tana Toraja - Dikembangkan oleh : Fuad Amry | Dicetak pada: <span id="pDate"></span>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx3PQul-FYo7glI2xNRUnT52RRLWcOW6U0z7ZVVyN3yXc3jVTKuJybp6P3SZk5fyuzR/exec";
    let db = [];

    async function load() {
        try {
            const r = await fetch(API_URL + "?t=" + Date.now());
            db = await r.json();
            
            const kels = [...new Set(db.map(x => x.kelurahan))].sort();
            document.getElementById("fKel").innerHTML = '<option value="">Semua Wilayah</option>' + kels.map(k => `<option>${k}</option>`).join('');
            
            const opds = [...new Set(db.map(x => x.opd))].sort();
            document.getElementById("fOPD").innerHTML = '<option value="">Semua OPD</option>' + opds.map(o => `<option>${o}</option>`).join('');

            filter();
        } catch (e) { document.getElementById("tbody").innerHTML = "Gagal memuat data."; }
    }

    function filter() {
        const k = document.getElementById("fKel").value;
        const o = document.getElementById("fOPD").value;
        const s = document.getElementById("src").value.toLowerCase();
        
        const res = db.filter(x => (!k || x.kelurahan === k) && (!o || x.opd === o) && (!s || JSON.stringify(x).toLowerCase().includes(s)));
        
        document.getElementById("totalKec").innerText = "Rp " + db.reduce((a,b)=>a+(Number(b.anggaran)||0),0).toLocaleString('id-ID');
        document.getElementById("totalFil").innerText = "Rp " + res.reduce((a,b)=>a+(Number(b.anggaran)||0),0).toLocaleString('id-ID');
        document.getElementById("pDate").innerText = new Date().toLocaleString('id-ID');

        let html = "";
        res.forEach((x, i) => {
            html += `<tr><td>${i+1}</td><td>${x.kelurahan}</td><td>${x.bidang}</td><td>${x.kegiatan}</td><td>${x.lokasi}</td><td>${x.volume}</td><td>${Number(x.anggaran).toLocaleString('id-ID')}</td><td><b>${x.opd}</b></td><td>${x.keterangan}</td></tr>`;
        });
        document.getElementById("tbody").innerHTML = html;
        
        // Update Stats
        let st = {}; res.forEach(x => st[x.opd] = (st[x.opd]||0)+1);
        document.getElementById("opdStats").innerHTML = Object.entries(st).sort((a,b)=>b[1]-a[1]).map(e => `<div class="opd-item"><span>${e[0]}</span><span style="font-weight:bold">${e[1]} Usulan</span></div>`).join('');
    }

    function exportEx() {
        const html = `<html><meta charset="UTF-8"><body><h2>REKAP MUSRENBANG MAKALE</h2>${document.getElementById("mainTab").outerHTML}</body></html>`;
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([html], {type:"application/vnd.ms-excel"})); a.download = "Rekap_Makale.xls"; a.click();
    }

    load();
    setInterval(()=> document.getElementById("clock").innerText = new Date().toLocaleString('id-ID'), 1000);
</script>
</body>
</html>