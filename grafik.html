<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Grafik Musrenbang</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f9; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .bar-container { margin-top: 30px; }
        .bar-item { margin-bottom: 25px; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .bar-bg { background: #e2e8f0; height: 30px; border-radius: 15px; overflow: hidden; }
        .bar-fill { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; transition: width 1s ease-in-out; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; color:#2d3748;">ðŸ“Š Analisis Anggaran Per Bidang (Kecamatan)</h2>
    <div id="grafikArea" class="bar-container">
        <p style="text-align:center;">Memproses data usulan...</p>
    </div>
    <button onclick="location.href='dashboard_admin.html'" style="width:100%; margin-top:30px; padding:12px; cursor:pointer; background:#718096; color:white; border:none; border-radius:6px; font-weight:bold;">â¬… Kembali ke Dashboard</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzSQzpDYFmZa3JZhSX8Y5P_wLwNXxihegGqtT5RGL7AGeaTzmR6yCUSPsS1IkfVwEtX/exec";
    const colors = {
        "Bidang Sarana dan Prasarana": "#3182ce",
        "Bidang Sosial Budaya": "#e53e3e",
        "Bidang Ekonomi": "#38a169",
        "Default": "#718096"
    };

    async function muatGrafik() {
        const area = document.getElementById("grafikArea");
        try {
            const resp = await fetch(API_URL + "?t=" + new Date().getTime());
            const data = await resp.json();
            
            const rekap = {};
            let totalMax = 0;

            data.forEach(d => {
                const b = d.bidang || "Lainnya";
                const a = parseFloat(d.anggaran) || 0;
                rekap[b] = (rekap[b] || 0) + a;
                if(rekap[b] > totalMax) totalMax = rekap[b];
            });

            area.innerHTML = "";
            const keys = Object.keys(rekap);
            if(keys.length === 0) {
                area.innerHTML = "<p style='text-align:center'>Belum ada data untuk ditampilkan.</p>";
                return;
            }

            keys.forEach(b => {
                const persen = totalMax > 0 ? (rekap[b] / totalMax) * 100 : 0;
                area.innerHTML += `
                    <div class="bar-item">
                        <div class="bar-label"><span>${b}</span><span>Rp ${rekap[b].toLocaleString('id-ID')}</span></div>
                        <div class="bar-bg">
                            <div class="bar-fill" style="width:${persen}%; background:${colors[b] || colors.Default}">${Math.round(persen)}%</div>
                        </div>
                    </div>`;
            });
        } catch(e) { area.innerHTML = "<p style='color:red; text-align:center;'>Gagal memuat grafik dari Cloud.</p>"; }
    }
    muatGrafik();
</script>
</body>
</html>