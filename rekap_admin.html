<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekapitulasi Admin - Cloud</title>
    <style>
        body { font-family: Arial; background: #f4f6f9; margin: 0; }
        .header { display: flex; align-items: center; background: #2c7be5; color: white; padding: 12px 20px; }
        .logo { width: 45px; margin-right: 15px; }
        .container { padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #2c7be5; color: white; cursor: pointer; border: none; }
        button.btn-pdf { background: #dc3545; }
        button.btn-excel { background: #28a745; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 13px; }
        th { background: #f8f9fa; }
        @media print { .header, .controls, button { display: none !important; } .card { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo_Tana_Toraja.png" class="logo">
        <strong>Rekapitulasi Usulan (Sumber: Cloud)</strong>
    </div>

    <div class="container">
        <div class="card">
            <div class="controls">
                <select id="filterKel" onchange="tampilkan()">
                    <option value="">Semua Kelurahan</option>
                </select>
                <select id="filterBidang" onchange="tampilkan()">
                    <option value="">Semua Bidang</option>
                    <option>Sarana dan Prasarana</option>
                    <option>Sosial Budaya</option>
                    <option>Ekonomi</option>
                </select>
                <button class="btn-excel" onclick="exportExcel()">Export Excel</button>
                <button class="btn-pdf" onclick="window.print()">Print PDF</button>
                <button onclick="location.href='dashboard_admin.html'">Kembali</button>
            </div>

            <table id="tabelRekap">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Kelurahan</th>
                        <th>Bidang</th>
                        <th>Kegiatan</th>
                        <th>Lokasi</th>
                        <th>Anggaran (Rp)</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
                <tfoot>
                    <tr style="font-weight:bold; background:#eee;">
                        <td colspan="5" style="text-align:right">TOTAL ANGGARAN:</td>
                        <td id="totalAnggaran">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx5GcGHWBBuUvZ9zWzyzMl3PjvhQXvTrAPnLpbCHvhVCAR0Jc_w3ENIec589FJIpTdc/exec"; // GANTI DENGAN URL APPS SCRIPT ANDA
        let dataCloud = [];

        async function muatData() {
            document.getElementById("tbody").innerHTML = "<tr><td colspan='6' style='text-align:center'>Memuat data dari Google Sheets...</td></tr>";
            try {
                const response = await fetch(API_URL);
                dataCloud = await response.json();
                updateFilterKelurahan();
                tampilkan();
            } catch (e) {
                alert("Gagal memuat data cloud.");
            }
        }

        function updateFilterKelurahan() {
            const listKel = [...new Set(dataCloud.map(d => d.kelurahan))];
            const select = document.getElementById("filterKel");
            listKel.forEach(k => { select.innerHTML += `<option>${k}</option>`; });
        }

        function tampilkan() {
            const fKel = document.getElementById("filterKel").value;
            const fBid = document.getElementById("filterBidang").value;
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "";
            
            let total = 0;
            let no = 1;

            dataCloud.filter(d => (!fKel || d.kelurahan === fKel) && (!fBid || d.bidang === fBid))
            .forEach(d => {
                const ang = Number(d.anggaran) || 0;
                total += ang;
                tbody.innerHTML += `<tr>
                    <td>${no++}</td>
                    <td>${d.kelurahan}</td>
                    <td>${d.bidang}</td>
                    <td>${d.kegiatan}</td>
                    <td>${d.lokasi}</td>
                    <td>${ang.toLocaleString('id-ID')}</td>
                </tr>`;
            });
            document.getElementById("totalAnggaran").innerText = total.toLocaleString('id-ID');
        }

        function exportExcel() {
            let table = document.getElementById("tabelRekap").outerHTML;
            let html = `<html><head><meta charset="UTF-8"></head><body><h2>Laporan Rekap Musrenbang</h2>${table}</body></html>`;
            let blob = new Blob([html], {type: "application/vnd.ms-excel"});
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Rekap_Musrenbang_Cloud.xls";
            a.click();
        }

        muatData();
    </script>
</body>
</html>