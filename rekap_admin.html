<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekapitulasi Admin - Cloud</title>
    <style>
        body { font-family: Arial; background: #f4f6f9; margin: 0; }
        .header { display: flex; align-items: center; background: #2c7be5; color: white; padding: 12px 20px; }
        .logo { width: 45px; margin-right: 15px; }
        .container { padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .no-print { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 13px; }
        th { background: #f8f9fa; }
        select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background: #2c7be5; color: white; cursor: pointer; border: none; }
        @media print { .no-print, .header { display: none !important; } }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo_Tana_Toraja.png" class="logo">
        <strong>Rekapitulasi Usulan (Data Cloud Google Sheets)</strong>
    </div>

    <div class="container">
        <div class="card">
            <div class="no-print">
                <select id="filterKel" onchange="tampilkan()"><option value="">Semua Kelurahan</option></select>
                <select id="filterBidang" onchange="tampilkan()">
                    <option value="">Semua Bidang</option>
                    <option>Bidang Sarana dan Prasarana</option>
                    <option>Bidang Sosial Budaya</option>
                    <option>Bidang Ekonomi</option>
                </select>
                <button style="background:#28a745" onclick="exportExcel()">üì• Export Excel</button>
                <button style="background:#dc3545" onclick="window.print()">üñ®Ô∏è Print PDF</button>
                <button style="background:#6c757d" onclick="location.href='dashboard_admin.html'">‚¨Ö Kembali</button>
            </div>

            <table id="tabelRekap">
                <thead>
                    <tr><th>No</th><th>Kelurahan</th><th>Bidang</th><th>Kegiatan</th><th>Lokasi</th><th>Anggaran (Rp)</th></tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzGB9apZUTZ01zLylAWI8ZH_hMqZTGgZFJoKp1nDgc0c5yUvpSkn3cxJHeaNpzqBFow/exec";
        let dataCloud = [];

        async function muatData() {
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Memuat data dari Google Sheets...</td></tr>";
            try {
                // Tambahkan no-cache agar data selalu fresh
                const resp = await fetch(API_URL + "?t=" + new Date().getTime());
                dataCloud = await resp.json();
                const listKel = [...new Set(dataCloud.map(d => d.kelurahan))];
                const filterKel = document.getElementById("filterKel");
                listKel.forEach(k => { if(k) filterKel.innerHTML += `<option>${k}</option>`; });
                tampilkan();
            } catch (e) { 
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Gagal memuat data cloud. Pastikan Apps Script sudah di-deploy sebagai 'Anyone'.</td></tr>"; 
            }
        }

        function tampilkan() {
            const fKel = document.getElementById("filterKel").value;
            const fBid = document.getElementById("filterBidang").value;
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "";
            let no = 1;
            dataCloud.filter(d => (!fKel || d.kelurahan === fKel) && (!fBid || d.bidang === fBid)).forEach(d => {
                tbody.innerHTML += `<tr><td>${no++}</td><td>${d.kelurahan}</td><td>${d.bidang}</td><td>${d.kegiatan}</td><td>${d.lokasi}</td><td>${Number(d.anggaran).toLocaleString('id-ID')}</td></tr>`;
            });
        }

        function exportExcel() {
            let html = `<html><head><meta charset="UTF-8"></head><body>${document.getElementById("tabelRekap").outerHTML}</body></html>`;
            let blob = new Blob([html], {type: "application/vnd.ms-excel"});
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Rekap_Musrenbang_Kecamatan.xls";
            a.click();
        }
        muatData();
    </script>
</body>
</html>