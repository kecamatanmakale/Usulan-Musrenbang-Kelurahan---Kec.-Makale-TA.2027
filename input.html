<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Usulan Musrenbang</title>

<style>
body { margin: 0; font-family: Arial; background: #f4f6f9; }
.header { display: flex; align-items: center; background: #2c7be5; color: white; padding: 12px 20px; }
.logo { width: 45px; margin-right: 15px; }
.container { padding: 20px; }
.card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select, textarea, button { width: 100%; padding: 8px; margin-top: 8px; box-sizing: border-box; }
textarea { resize: vertical; }
button { background: #2c7be5; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }
button.edit { background: #ffc107; color: #000; width: auto; padding: 5px 10px; margin-right: 5px; }
button.hapus { background: #dc3545; width: auto; padding: 5px 10px; }
button.success { background: #28a745; width: auto; padding: 10px 20px; }
button.danger { background: #dc3545; width: auto; padding: 10px 20px; }
button.secondary { background: #6c757d; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f8f9fa; }
@media print { .no-print, .header, .card:first-child, button { display: none !important; } .card { box-shadow: none; border: none; } }
</style>
</head>

<body>

<div class="header">
  <img src="Logo_Tana_Toraja.png" class="logo">
  <strong id="judulHeader">Musrenbang Kelurahan</strong>
</div>

<div class="container">

<div class="card no-print">
  <h3>‚ûï Input Usulan Musrenbang</h3>
  <input type="hidden" id="editIndex">

  <label>Kelurahan</label>
  <input id="kelurahan" readonly style="background:#eee">

  <label>Bidang Program</label>
  <select id="bidang">
    <option value="">-- Pilih Bidang Program --</option>
    <option>Bidang Sarana dan Prasarana</option>
    <option>Bidang Sosial Budaya</option>
    <option>Bidang Ekonomi</option>
  </select>

  <label>Nama Kegiatan</label>
  <textarea id="kegiatan" placeholder="Contoh: Rehabilitasi Jalan Lingkungan"></textarea>

  <label>Lokasi</label>
  <input id="lokasi" placeholder="Lokasi spesifik">

  <label>Volume</label>
  <input id="volume" placeholder="Contoh: 100 Meter / 1 Unit">

  <label>Anggaran (Rp)</label>
  <input id="anggaran" type="number" placeholder="Masukkan angka saja">

  <label>Keterangan</label>
  <textarea id="keterangan" placeholder="Keterangan tambahan..."></textarea>

  <button id="btnSimpan" onclick="simpanUsulan()">üíæ Simpan & Kirim ke Cloud</button>
  <button class="secondary" onclick="kembali()">‚¨Ö Kembali ke Dashboard</button>
</div>

<div class="card">
  <h3 id="tabelJudul">üìÑ Memuat Data Usulan...</h3>
  
  <div class="no-print" style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button class="success" onclick="exportExcel()">üì§ Export Excel</button>
    <button class="danger" onclick="window.print()">üñ®Ô∏è Print PDF</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th>
        <th>Bidang</th>
        <th>Kegiatan</th>
        <th>Lokasi</th>
        <th>Anggaran (Rp)</th>
        <th class="no-print">Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelUsulan"></tbody>
  </table>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzGB9apZUTZ01zLylAWI8ZH_hMqZTGgZFJoKp1nDgc0c5yUvpSkn3cxJHeaNpzqBFow/exec";
const kelurahanLogin = localStorage.getItem("kelurahan") || "Umum";

// Setup Judul
judulHeader.innerText = "Musrenbang - " + kelurahanLogin;
kelurahan.value = kelurahanLogin;
document.getElementById("tabelJudul").innerText = "üìÑ Daftar Usulan " + kelurahanLogin;

let dataUsulan = [];

/* ================= AMBIL DATA DARI CLOUD (SETIAP REFRESH/LOGIN) ================= */
async function muatDataDariCloud() {
  const tbody = document.getElementById("tabelUsulan");
  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Menyinkronkan data dengan Cloud...</td></tr>";
  
  try {
    const resp = await fetch(API_URL);
    const allData = await resp.json();
    
    // Filter hanya data milik kelurahan ini
    dataUsulan = allData.filter(d => d.kelurahan === kelurahanLogin);
    tampilkan();
  } catch (e) {
    console.error(e);
    // Jika cloud gagal, coba ambil dari local storage sebagai cadangan
    dataUsulan = JSON.parse(localStorage.getItem("dataUsulan")) || [];
    tampilkan();
    alert("Gagal sinkron dengan Cloud. Menampilkan data lokal terakhir.");
  }
}

/* ================= TAMPILKAN TABEL ================= */
function tampilkan() {
  const tbody = document.getElementById("tabelUsulan");
  tbody.innerHTML = "";
  let no = 1;

  dataUsulan.forEach((d, i) => {
    tbody.innerHTML += `
    <tr>
      <td>${no++}</td>
      <td>${d.bidang}</td>
      <td>${d.kegiatan}</td>
      <td>${d.lokasi}</td>
      <td>${Number(d.anggaran).toLocaleString("id-ID")}</td>
      <td class="no-print">
        <button class="edit" onclick="editUsulan(${i})">Edit</button>
        <button class="hapus" onclick="hapusUsulan(${i})">Hapus</button>
      </td>
    </tr>`;
  });
}

/* ================= SIMPAN DATA ================= */
async function simpanUsulan() {
  if (!bidang.value || !kegiatan.value) return alert("Bidang dan Nama Kegiatan wajib diisi!");

  const data = {
    kelurahan: kelurahanLogin,
    bidang: bidang.value,
    kegiatan: kegiatan.value,
    lokasi: lokasi.value,
    volume: volume.value,
    anggaran: anggaran.value,
    keterangan: keterangan.value
  };

  const btn = document.getElementById("btnSimpan");
  btn.disabled = true;
  btn.innerText = "‚åõ Mengirim...";

  try {
    // Kirim ke Google Sheets
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(data)
    });

    alert("Data berhasil tersimpan permanen di Cloud!");
    
    // Simpan juga ke Lokal sebagai cadangan
    const localData = JSON.parse(localStorage.getItem("dataUsulan")) || [];
    localData.push(data);
    localStorage.setItem("dataUsulan", JSON.stringify(localData));

    resetForm();
    muatDataDariCloud(); // Refresh data langsung dari cloud
  } catch (e) {
    alert("Gagal mengirim ke Cloud!");
  } finally {
    btn.disabled = false;
    btn.innerText = "üíæ Simpan & Kirim ke Cloud";
  }
}

function editUsulan(i) {
  const d = dataUsulan[i];
  bidang.value = d.bidang;
  kegiatan.value = d.kegiatan;
  lokasi.value = d.lokasi;
  volume.value = d.volume;
  anggaran.value = d.anggaran;
  keterangan.value = d.keterangan;
  window.scrollTo(0, 0);
  alert("Silakan perbaiki data. Catatan: Data lama di Cloud tetap ada, data baru akan tersimpan sebagai usulan baru.");
}

function hapusUsulan(i) {
  if (confirm("Hapus usulan dari tampilan lokal? (Catatan: Data di Google Sheets Admin tetap tersimpan)")) {
    dataUsulan.splice(i, 1);
    tampilkan();
  }
}

function exportExcel() {
  let table = document.querySelector("table").cloneNode(true);
  let rows = table.rows;
  for (let i = 0; i < rows.length; i++) { rows[i].deleteCell(-1); }
  let html = `<html><head><meta charset="UTF-8"></head><body><h2>Daftar Usulan ${kelurahanLogin}</h2>${table.outerHTML}</body></html>`;
  let blob = new Blob([html], { type: "application/vnd.ms-excel" });
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Usulan_${kelurahanLogin}.xls`;
  a.click();
}

function resetForm() {
  bidang.value = ""; kegiatan.value = ""; lokasi.value = "";
  volume.value = ""; anggaran.value = ""; keterangan.value = "";
}

function kembali() { location.href = "dashboard.html"; }

// JALANKAN SYNC SAAT HALAMAN DIBUKA
muatDataDariCloud();
</script>

</body>
</html>