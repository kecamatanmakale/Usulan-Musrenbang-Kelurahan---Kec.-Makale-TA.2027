<!DOCTYPE html>
<html>
<head>
    <title>Input Usulan</title>
    <style>
        body { font-family: sans-serif; background: #f4f6f9; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 8px; max-width: 900px; margin: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
        .no-print { margin-bottom: 10px; }
        
        @media print {
            .no-print, #fUsulan, button, hr { display: none !important; }
            body { background: white; padding: 0; }
            .card { box-shadow: none; border: none; width: 100%; max-width: none; }
            .print-header { display: block !important; text-align: center; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <div class="no-print">
            <button onclick="location.href='dashboard.html'" style="background:#666">‚¨Ö Kembali</button>
            <button onclick="window.print()" style="background:#3498db">üñ®Ô∏è Cetak PDF</button>
        </div>

        <div class="print-header">
            <img src="Logo_Tana_Toraja.png" width="60">
            <h3>DAFTAR USULAN MUSRENBANG KECAMATAN MAKALE</h3>
            <h4 id="labelKelPrint"></h4>
            <hr style="border:1px solid black">
        </div>

        <h3>Wilayah: <span id="namaKel"></span></h3>
        <form id="fUsulan">
            <input type="hidden" id="rowId">
            <select id="bidang" required>
                <option value="">-- Pilih Bidang --</option>
                <option>Bidang Sarana dan Prasarana</option>
                <option>Bidang Sosial Budaya</option>
                <option>Bidang Ekonomi</option>
            </select>
            <input type="text" id="kegiatan" placeholder="Nama Kegiatan" required>
            <input type="text" id="lokasi" placeholder="Lokasi Spesifik" required>
            <input type="text" id="volume" placeholder="Volume (Contoh: 100m / 2 Unit)" required>
            <input type="number" id="anggaran" placeholder="Anggaran (Rp)" required>
            <select id="opd" required>
                <option value="">-- Pilih OPD Tujuan --</option>
                <option>Diskominfo dan Persandian</option><option>DPUTR</option><option>DPRKP</option>
                <option>Dinas Kesehatan</option><option>Pendidikan dan Kebudayaan</option><option>Disparpora</option>
                <option>Dinas Sosial</option><option>Disdukcapil</option><option>Diskop UKM Perindag</option>
                <option>DLHD</option><option>DPML</option><option>DPMPTSP</option><option>Dinas Perhubungan</option>
                <option>DP3A dan KB</option><option>Dinas Perpustakaan dan Arsip Daerah</option>
                <option>Pertanian, Ketahanan Pangan dan Perikanan</option><option>Disnakertrans</option>
                <option>Bappelitbangda</option><option>BPKPD</option><option>BKPSDM</option>
                <option>Kesbangpol</option><option>BPBD</option><option>Inspektorat Daerah</option>
                <option>Satpolpp</option><option>Sekretariat Daerah</option><option>Sekretariat DPRD</option>
                <option>RSUD Lakipadada</option>
            </select>
            <textarea id="keterangan" placeholder="Keterangan tambahan"></textarea>
            <button type="submit" id="btnProses">KIRIM USULAN</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Kegiatan</th><th>Lokasi</th><th>Volume</th><th>Anggaran</th><th>OPD</th><th class="no-print">Aksi</th>
                </tr>
            </thead>
            <tbody id="isiTabel"></tbody>
        </table>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxYWQJk2oEE6O3NaL_gZV771dCzGThihUpWkzQCAsMFiM4fpcbKOAWUgn8cAX4-orp3/exec";
        const kel = localStorage.getItem("kelurahan");
        if(!kel) location.href="index.html";
        document.getElementById("namaKel").innerText = kel;
        document.getElementById("labelKelPrint").innerText = "Wilayah: " + kel;

        async function loadData() {
            const r = await fetch(API + "?t=" + Date.now());
            const data = await r.json();
            const filtered = data.filter(x => x.kelurahan === kel);
            let h = "";
            filtered.reverse().forEach(d => {
                h += `<tr>
                    <td>${d.kegiatan}</td><td>${d.lokasi}</td><td>${d.volume}</td>
                    <td>${Number(d.anggaran).toLocaleString()}</td><td>${d.opd}</td>
                    <td class="no-print"><button onclick="hapus('${d.timestamp}')" style="background:red; padding:5px;">‚úñ</button></td>
                </tr>`;
            });
            document.getElementById("isiTabel").innerHTML = h;
        }

        document.getElementById("fUsulan").onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById("btnProses");
            btn.disabled = true; btn.innerText = "Mengirim...";
            const payload = {
                action: "insert",
                kelurahan: kel, bidang: document.getElementById("bidang").value,
                kegiatan: document.getElementById("kegiatan").value, lokasi: document.getElementById("lokasi").value,
                volume: document.getElementById("volume").value, anggaran: document.getElementById("anggaran").value,
                opd: document.getElementById("opd").value, keterangan: document.getElementById("keterangan").value
            };
            await fetch(API, { method: "POST", body: JSON.stringify(payload) });
            alert("Data Berhasil Terkirim!");
            document.getElementById("fUsulan").reset();
            btn.disabled = false; btn.innerText = "KIRIM USULAN";
            loadData();
        };

        async function hapus(ts) {
            if(confirm("Hapus usulan ini?")) {
                await fetch(API, { method: "POST", body: JSON.stringify({action:"delete", rowId: ts}) });
                loadData();
            }
        }
        loadData();
    </script>
</body>
</html>