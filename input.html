<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Input Usulan Musrenbang</title>
    <style>
        body { margin: 0; font-family: Arial; background: #f4f6f9; }
        .header { display: flex; align-items: center; background: #2c7be5; color: white; padding: 12px 20px; }
        .logo { width: 45px; margin-right: 15px; }
        .container { padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; }
        button { background: #2c7be5; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; }
        button.warning { background: #ffc107; color: black; }
        button.success { background: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        @media print { .header, .card:first-child, button, .no-print { display: none !important; } .card { box-shadow: none; border: none; } }
    </style>
</head>
<body>
    <div class="header">
        <img src="Logo_Tana_Toraja.png" class="logo">
        <strong id="judulHeader">Input Usulan Musrenbang</strong>
    </div>

    <div class="container">
        <div class="card no-print">
            <h3>‚ûï Form Tambah Usulan</h3>
            <input type="hidden" id="editIndex">
            <label>Kelurahan: <input id="kelurahanDisp" readonly style="background:#eee"></label>
            <select id="bidang">
                <option value="">-- Pilih Bidang --</option>
                <option>Bidang Sarana dan Prasarana</option>
                <option>Bidang Sosial Budaya</option>
                <option>Bidang Ekonomi</option>
            </select>
            <textarea id="kegiatan" placeholder="Nama Kegiatan"></textarea>
            <input id="lokasi" placeholder="Lokasi Spesifik">
            <input id="volume" placeholder="Volume (Contoh: 100 Meter)">
            <input id="anggaran" type="number" placeholder="Estimasi Anggaran (Rp)">
            <textarea id="keterangan" placeholder="Keterangan tambahan..."></textarea>
            <button onclick="simpanUsulan()">üíæ Simpan & Kirim ke Cloud</button>
            <button class="secondary" onclick="location.href='dashboard.html'">‚¨Ö Kembali ke Dashboard</button>
        </div>

        <div class="card">
            <h3>üìÑ Data Usulan Kelurahan</h3>
            <div class="no-print" style="display: flex; gap: 10px;">
                <button class="success" onclick="exportExcel()">üì§ Export Excel</button>
                <button class="danger" onclick="window.print()">üñ®Ô∏è Print PDF</button>
            </div>
            <table id="tabelData">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Bidang</th>
                        <th>Kegiatan</th>
                        <th>Lokasi</th>
                        <th>Anggaran (Rp)</th>
                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx5GcGHWBBuUvZ9zWzyzMl3PjvhQXvTrAPnLpbCHvhVCAR0Jc_w3ENIec589FJIpTdc/exec";
        const kelurahanLogin = localStorage.getItem("kelurahan") || "Umum";
        document.getElementById("judulHeader").innerText = "Musrenbang - " + kelurahanLogin;
        document.getElementById("kelurahanDisp").value = kelurahanLogin;

        let dataUsulan = JSON.parse(localStorage.getItem("dataUsulan")) || [];

        function simpanUsulan() {
            const data = {
                kelurahan: kelurahanLogin,
                bidang: document.getElementById("bidang").value,
                kegiatan: document.getElementById("kegiatan").value,
                lokasi: document.getElementById("lokasi").value,
                volume: document.getElementById("volume").value,
                anggaran: document.getElementById("anggaran").value,
                keterangan: document.getElementById("keterangan").value
            };

            if (!data.bidang || !data.kegiatan) return alert("Isi Bidang dan Kegiatan!");

            const idx = document.getElementById("editIndex").value;
            if (idx === "") {
                dataUsulan.push(data);
                fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
                alert("Data berhasil dikirim ke Cloud!");
            } else {
                dataUsulan[idx] = data;
                document.getElementById("editIndex").value = "";
                alert("Data diperbarui secara lokal!");
            }

            localStorage.setItem("dataUsulan", JSON.stringify(dataUsulan));
            resetForm();
            tampilkan();
        }

        function tampilkan() {
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "";
            dataUsulan.filter(d => d.kelurahan === kelurahanLogin).forEach((d, i) => {
                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td>${d.bidang}</td>
                    <td>${d.kegiatan}</td>
                    <td>${d.lokasi}</td>
                    <td>${Number(d.anggaran).toLocaleString('id-ID')}</td>
                    <td class="no-print">
                        <button class="warning" style="width:auto; padding:5px 10px;" onclick="edit(${i})">Edit</button>
                        <button class="danger" style="width:auto; padding:5px 10px;" onclick="hapus(${i})">Hapus</button>
                    </td>
                </tr>`;
            });
        }

        function edit(i) {
            const d = dataUsulan[i];
            document.getElementById("bidang").value = d.bidang;
            document.getElementById("kegiatan").value = d.kegiatan;
            document.getElementById("lokasi").value = d.lokasi;
            document.getElementById("volume").value = d.volume;
            document.getElementById("anggaran").value = d.anggaran;
            document.getElementById("keterangan").value = d.keterangan;
            document.getElementById("editIndex").value = i;
            window.scrollTo(0,0);
        }

        function hapus(i) {
            if(confirm("Hapus usulan ini?")) {
                dataUsulan.splice(i, 1);
                localStorage.setItem("dataUsulan", JSON.stringify(dataUsulan));
                tampilkan();
            }
        }

        function exportExcel() {
            let table = document.getElementById("tabelData").cloneNode(true);
            let rows = table.rows;
            for (let i = 0; i < rows.length; i++) { rows[i].deleteCell(-1); }
            let html = `<html><head><meta charset="UTF-8"></head><body><h2>Usulan ${kelurahanLogin}</h2>${table.outerHTML}</body></html>`;
            let blob = new Blob([html], {type: "application/vnd.ms-excel"});
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `Usulan_${kelurahanLogin}.xls`;
            a.click();
        }

        function resetForm() { document.querySelectorAll("input, textarea, select").forEach(i => { if(i.id!=="kelurahanDisp") i.value = ""; }); }
        tampilkan();
    </script>
</body>
</html>