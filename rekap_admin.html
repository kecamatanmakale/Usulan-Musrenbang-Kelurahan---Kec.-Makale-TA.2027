<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Usulan Musrenbang - Admin Kecamatan</title>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #f4f6f9;
}

/* HEADER */
.header {
  display: flex;
  align-items: center;
  background: #2c7be5;
  color: white;
  padding: 12px 20px;
}

.logo {
  width: 45px;
  margin-right: 15px;
}

.container {
  padding: 20px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

select, button {
  padding: 8px;
  margin-right: 10px;
}

button {
  background: #2c7be5;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}

button.excel {
  background: #28a745;
}

button.pdf {
  background: #dc3545;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

table, th, td {
  border: 1px solid #ccc;
}

th, td {
  padding: 8px;
  text-align: left;
}

tfoot td {
  font-weight: bold;
  background: #f1f1f1;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="Logo_Tana_Toraja.png" class="logo">
  <strong>Rekapitulasi Usulan Musrenbang - Admin Kecamatan</strong>
</div>

<div class="container">

<!-- FILTER -->
<div class="card">
  <h3>ðŸ”Ž Filter Data</h3>

  <select id="filterKelurahan">
    <option value="">Semua Kelurahan</option>
  </select>

  <select id="filterBidang">
    <option value="">Semua Bidang</option>
    <option>Bidang Sarana dan Prasarana</option>
    <option>Bidang Sosial Budaya</option>
    <option>Bidang Ekonomi</option>
  </select>

  <button onclick="tampilkan()">Tampilkan</button>
</div>

<!-- DATA -->
<div class="card">
  <h3>ðŸ“Š Rekap Usulan</h3>

  <button class="excel" onclick="exportExcel()">â¬‡ Export Excel</button>
  <button class="pdf" onclick="window.print()">ðŸ–¨ Print PDF</button>

  <table id="tabel">
    <thead>
      <tr>
        <th>No</th>
        <th>Kelurahan</th>
        <th>Bidang</th>
        <th>Nama Kegiatan</th>
        <th>Lokasi</th>
        <th>Volume</th>
        <th>Anggaran (Rp)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <td colspan="6">TOTAL ANGGARAN</td>
        <td id="totalAnggaran">0</td>
      </tr>
    </tfoot>
  </table>

  <br>
  <button onclick="kembali()">â¬… Kembali ke Dashboard</button>
</div>

</div>

<script>
/* ================= KONFIGURASI ================= */
const API_URL = "TEMPEL_URL_WEB_APP_BARU_DI_SINI";

if (localStorage.getItem("role") !== "admin") {
  location.href = "index.html";
}

let dataUsulan = [];

/* ================= AMBIL DATA DARI CLOUD ================= */
async function muatDataCloud() {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>Memuat data dari Cloud...</td></tr>";

  try {
    const response = await fetch(API_URL);
    dataUsulan = await response.json();
    
    // Update Filter Kelurahan secara dinamis
    updateFilterOptions();
    tampilkan();
  } catch (err) {
    console.error("Gagal memuat data:", err);
    // Fallback ke data lokal jika gagal
    dataUsulan = JSON.parse(localStorage.getItem("dataUsulan")) || [];
    tampilkan();
  }
}

function updateFilterOptions() {
  const kelSet = new Set();
  dataUsulan.forEach(d => kelSet.add(d.kelurahan));
  
  const filterKel = document.getElementById("filterKelurahan");
  filterKel.innerHTML = '<option value="">Semua Kelurahan</option>';
  kelSet.forEach(k => {
    filterKel.innerHTML += `<option>${k}</option>`;
  });
}

function tampilkan() {
  const tbody = document.getElementById("tbody");
  const totalAnggaran = document.getElementById("totalAnggaran");
  tbody.innerHTML = "";
  let no = 1;
  let total = 0;

  const kel = document.getElementById("filterKelurahan").value;
  const bidang = document.getElementById("filterBidang").value;

  dataUsulan
    .filter(d => (!kel || d.kelurahan === kel))
    .filter(d => (!bidang || d.bidang === bidang))
    .forEach(d => {
      total += Number(d.anggaran || 0);
      tbody.innerHTML += `
        <tr>
          <td>${no++}</td>
          <td>${d.kelurahan}</td>
          <td>${d.bidang}</td>
          <td>${d.kegiatan}</td>
          <td>${d.lokasi}</td>
          <td>${d.volume || '-'}</td>
          <td>${Number(d.anggaran).toLocaleString("id-ID")}</td>
        </tr>`;
    });

  totalAnggaran.innerText = total.toLocaleString("id-ID");
}

// Jalankan pengambilan data saat halaman dibuka
muatDataCloud();

/* ================= EXPORT & UTIL ================= */
function exportExcel() {
  let table = document.getElementById("tabel").outerHTML;
  let blob = new Blob([table], {type: "application/vnd.ms-excel"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "Rekap_Musrenbang_Cloud.xls";
  a.click();
}

function kembali() {
  location.href = "dashboard_admin.html";
}

</body>
</html>
